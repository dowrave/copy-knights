using TMPro;
using UnityEngine;
using UnityEngine.UI;


/// <summary>
/// 스테이지에서 사용되는, 오퍼레이터의 정보를 표시하는 패널입니다.
/// </summary>
public class InStageInfoPanel : MonoBehaviour
{

    [Header("Base Info Fields")]
    [SerializeField] private Image classIconImage;
    [SerializeField] private GameObject operatorLevelTextBox;
    [SerializeField] private Image promotionIconImage;
    [SerializeField] private TextMeshProUGUI nameText;
    [SerializeField] private TextMeshProUGUI levelText;

    [Header("Stat Fields")]
    [SerializeField] private TextMeshProUGUI healthText;
    [SerializeField] private TextMeshProUGUI attackText;
    [SerializeField] private TextMeshProUGUI defenseText;
    [SerializeField] private TextMeshProUGUI magicResistanceText;
    [SerializeField] private TextMeshProUGUI blockCountText;

    private Operator currentOperator;
    private DeployableUnitEntity currentDeployable;
    private GameObject statsContainer;
    private DeployableManager.DeployableInfo currentDeployableInfo;

    private void Awake() 
    {
        statsContainer = transform.Find("OperatorInfoContent/StatsContainer").gameObject;
        statsContainer.SetActive(false);
    }

    // 배치되지 않은 유닛 클릭 시 패널 정보 갱신
    public void UpdateUnDeployedInfo(DeployableManager.DeployableInfo deployableInfo)
    {
        currentDeployableInfo = deployableInfo;

        // Operator 정보 업데이트
        if (currentDeployableInfo.ownedOperator != null)
        {
            currentOperator = currentDeployableInfo.prefab.GetComponent<Operator>();
            currentDeployable = null;
            nameText.text = currentDeployableInfo.operatorData.entityName;
            UpdateOperatorInfo();
        }
        else // deployableUnitEntity 정보 업데이트
        {
            classIconImage.gameObject.SetActive(false);
            operatorLevelTextBox.gameObject.SetActive(false);

            currentDeployable = currentDeployableInfo.prefab.GetComponent<DeployableUnitEntity>();
            currentOperator = null;
            nameText.text = currentDeployableInfo.deployableUnitData.entityName;
            statsContainer.SetActive(false);
        }
    }

    // 배치된 유닛 클릭 시 패널 정보 갱신
    public void UpdateDeployedInfo(DeployableUnitEntity deployableUnitEntity)
    { 
        // 기존 이벤트 해제
        if (currentOperator != null)
        {
            currentOperator.OnHealthChanged -= UpdateHealthText;
            currentOperator.OnStatsChanged -= UpdateOperatorInfo;
        }

        if (deployableUnitEntity is Operator op)
        {
            currentOperator = op;
            currentDeployable = null;
            nameText.text = currentDeployableInfo.operatorData.entityName;
            UpdateOperatorInfo();
        }
        else
        {
            // 클래스 아이콘, 레벨 정보 가림
            classIconImage.gameObject.SetActive(false);
            operatorLevelTextBox.gameObject.SetActive(false);

            currentDeployable = deployableUnitEntity;
            currentOperator = null;
            nameText.text = currentDeployableInfo.deployableUnitData.entityName;
            statsContainer.SetActive(false);
        }
    }

    private void UpdateOperatorInfo()
    {
        if (currentOperator == null) return;

        OwnedOperator ownedOperator = currentDeployableInfo.ownedOperator;

        // 아이콘 이미지 패널 활성화 및 할당
        classIconImage.gameObject.SetActive(true);
        operatorLevelTextBox.gameObject.SetActive(true);
        OperatorIconHelper.SetClassIcon(classIconImage, ownedOperator.BaseData.operatorClass);
        OperatorIconHelper.SetElitePhaseIcon(promotionIconImage, ownedOperator.currentPhase);

        // 스탯 정보 보이게 하기
        statsContainer.SetActive(true);

        levelText.text = $"{ownedOperator.currentLevel}";

        if (currentOperator.IsDeployed)
        {
            currentOperator.OnHealthChanged += UpdateHealthText;
            currentOperator.OnStatsChanged += UpdateOperatorInfo;
        }

        var currentUnitStates = DeployableManager.Instance.UnitStates[currentDeployableInfo];

        UpdateStatText();
    }

    private void UpdateStatText()
    {
        // 배치된 경우 - 실시간 정보를 가져옴
        if (currentOperator.IsDeployed)
        {
            UpdateHealthText(currentOperator.CurrentHealth, currentOperator.MaxHealth);
            attackText.text = $"공격력: {Mathf.Ceil(currentOperator.currentStats.AttackPower)}";
            defenseText.text = $"방어력: {Mathf.Ceil(currentOperator.currentStats.Defense)}";
            magicResistanceText.text = $"마법저항력: {Mathf.Ceil(currentOperator.currentStats.MagicResistance)}";
            blockCountText.text = $"저지수: {Mathf.Ceil(currentOperator.currentStats.MaxBlockableEnemies)}";
        }
        // 배치되지 않은 경우 - ownedOperator의 정보를 가져옴
        else
        {
            OperatorStats ownedOperatorStats = currentDeployableInfo.ownedOperator.CurrentStats;

            // 배치되지 않은 경우 : OwnedOperator의 정보를 가져옴
            float initialHealth = ownedOperatorStats.Health;
            UpdateHealthText(initialHealth, initialHealth);
            attackText.text = $"공격력: {Mathf.Ceil(ownedOperatorStats.AttackPower)}";
            defenseText.text = $"방어력: {Mathf.Ceil(ownedOperatorStats.Defense)}";
            magicResistanceText.text = $"마법저항력: {Mathf.Ceil(ownedOperatorStats.MagicResistance)}";
            blockCountText.text = $"저지수: {Mathf.Ceil(ownedOperatorStats.MaxBlockableEnemies)}";
        }
    }

    private void UpdateHealthText(float currentHealth, float maxHealth, float currentShield = 0)
    {
        healthText.text = $"체력 <color=#ff6666>{Mathf.Ceil(currentHealth)} / {Mathf.Ceil(maxHealth)}</color>";
    }

    private void OnDisable()
    {
        if (currentOperator != null)
        {
            currentOperator.OnHealthChanged -= UpdateHealthText;
            currentOperator.OnStatsChanged -= UpdateOperatorInfo;
            currentOperator = null;
        }
    }
}
